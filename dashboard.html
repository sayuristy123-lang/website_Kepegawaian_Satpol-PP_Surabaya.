<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Kepegawaian Satpol PP</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { background-color: #f8f9fa; overflow-x: hidden; }
.sidebar { background-color: #212529; position: fixed; height: 100vh; width: 230px; color: white; }
.sidebar h4 { text-align: center; padding: 20px 0; font-weight: bold; }
.sidebar a { color: white; text-decoration: none; display: block; padding: 10px 20px; }
.sidebar a:hover, .sidebar a.active { background-color: #495057; border-radius: 4px; }
.main { margin-left: 230px; padding: 20px; }
.hidden { display: none; }
img.foto-pegawai { width: 60px; height: 70px; object-fit: cover; border-radius: 5px; }
</style>
</head>
<script type="module">
  // Import Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // Firebase Config (ISI DENGAN PUNYAMU)
  const firebaseConfig = {
    apiKey: "APIKEY_KAMU",
    authDomain: "PROJECTID.firebaseapp.com",
    databaseURL: "https://sayuristy123-lang.github.io/website_Kepegawaian_Satpol-PP_Surabaya./",
    projectId: "PROJECTID",
    storageBucket: "PROJECTID.appspot.com",
    messagingSenderId: "SENDERID",
    appId: "APPID"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Fungsi ambil data dari Firebase
  function loadDashboard() {
    const dbRef = ref(db);

    get(child(dbRef, "asn")).then((snapshot) => {
      if (snapshot.exists()) {
        document.getElementById("jumlahASN").innerHTML = snapshot.val().length;
      }
    });

    get(child(dbRef, "nonasn")).then((snapshot) => {
      if (snapshot.exists()) {
        document.getElementById("jumlahNonASN").innerHTML = snapshot.val().length;
      }
    });

    get(child(dbRef, "pelanggaran")).then((snapshot) => {
      if (snapshot.exists()) {
        document.getElementById("totalPelanggaran").innerHTML = snapshot.val().length;
      }
    });
  }

  // Jalankan
  loadDashboard();
</script>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h4><i class="fas fa-shield-alt me-2"></i>Satpol PP</h4>
  <a href="#" class="nav-link active" onclick="showPage('dashboard', this)">
    <i class="fas fa-home me-2"></i>Dashboard
  </a>
  <a href="#" class="nav-link" onclick="showPage('asn', this)">
    <i class="fas fa-user-tie me-2"></i>Database ASN
  </a>
  <a href="#" class="nav-link" onclick="showPage('nonasn', this)">
    <i class="fas fa-users me-2"></i>Database Non-ASN
  </a>
  <a href="#" class="nav-link" onclick="showPage('searchPage', this)"> 
    <i class="fas fa-search me-2"></i>Pencarian Data 
  </a>
  <a href="#" class="nav-link" onclick="showPage('historyPegawai', this)">
    <i class="fas fa-clock-rotate-left me-2"></i>History Pegawai
  </a>
  <a href="#" class="nav-link" onclick="showPage('settingPage', this)">
    <i class="fas fa-gear me-2"></i>Setting
  </a> 
</div>

<!-- Main -->
<div class="main">

<!-- DASHBOARD -->
<div id="dashboard">
  <h3><i class="fas fa-tachometer-alt me-2"></i>Dashboard Kepegawaian</h3>
  <div class="row mt-4">
    <div class="col-md-3"><div class="card bg-primary text-white p-3 text-center"><h3 id="jumlahASN">0</h3><p>Jumlah ASN</p></div></div>
    <div class="col-md-3"><div class="card bg-success text-white p-3 text-center"><h3 id="jumlahNonASN">0</h3><p>Jumlah Non-ASN</p></div></div>
    <div class="col-md-3"><div class="card bg-warning text-dark p-3 text-center"><h3 id="totalPelanggaran">0</h3><p>Total Pelanggaran</p></div></div>
  </div>
</div>

<!-- PENCARIAN DATA -->
<div id="searchPage" class="hidden">
  <h4><i class="fas fa-search me-2"></i>Pencarian Data Pegawai</h4>

  <div class="input-group my-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Cari berdasarkan Nama atau NIP...">
    <button class="btn btn-primary" onclick="searchData()"><i class="fas fa-search"></i> Cari</button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped" id="searchTable" style="display:none;">
      <thead class="table-success">
        <tr>
          <th>No</th>
          <th>Nama</th>
          <th>NIP</th>
          <th>Jabatan</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="searchResult"></tbody>
    </table>
  </div>
</div>

<!-- DATABASE ASN -->
<div id="asn" class="hidden">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>Database ASN</h4>

    <div>
      <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalASN">
        <i class="fas fa-plus me-1"></i> Tambah ASN
      </button>

      <button class="btn btn-sm btn-success me-2" onclick="document.getElementById('importASN').click()">
        <i class="fas fa-file-excel me-1"></i> Import Excel
      </button>
      <input type="file" id="importASN" accept=".xlsx,.xls" class="d-none">

      <button class="btn btn-sm btn-warning" onclick="exportASN()">
        <i class="fas fa-file-export me-1"></i> Export Excel
      </button>
    </div>
  </div>

  <div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Foto</th><th>Nama</th><th>NIP</th><th>TTL</th><th>Jenis Kelamin</th><th>No. Telepon</th><th>Email Pribadi</th>
        <th>Alamat Domisili</th><th>Alamat KTP</th><th>Jabatan</th><th>Pendidikan</th><th>Gol/Pangkat</th><th>Kelas Jabatan</th>
        <th>Tim Regu</th><th>Bidang SK/SPK</th><th>Bidang Penempatan</th><th>Jumlah Pelanggaran</th><th>Surat Peringatan</th>
        <th>SK/SPK</th><th>Status</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="bodyASN"></tbody>
  </table>
  </div>
</div>

<!-- MODAL ASN -->
<div class="modal fade" id="modalASN" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formASN">
        <div class="modal-header">
          <h5 class="modal-title" id="modalASNTitle">Tambah ASN</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="asn_index" value="-1">

          <div class="row">
            <div class="col-md-3 text-center">
              <label class="form-label">Foto (jpg/png)</label>
              <img id="asn_photo_preview" class="img-fluid mb-2" style="max-height:120px; display:none; border:1px solid #ddd; padding:4px;">
              <input class="form-control" type="file" id="asn_photo" accept="image/*">
            </div>

            <div class="col-md-9">
              <div class="row g-2">
                <div class="col-md-6"><input class="form-control" id="asn_nama" placeholder="Nama" required></div>
                <div class="col-md-6"><input class="form-control" id="asn_nip" placeholder="NIP" required></div>
                <div class="col-md-6"><input class="form-control" id="asn_ttl" placeholder="TTL" required></div>
                <div class="col-md-6"><input class="form-control" id="asn_telp" placeholder="No. Telepon"></div>

                <div class="col-md-6">
                  <select id="asn_jk" class="form-select">
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                  </select>
                </div>

                <div class="col-md-6"><input class="form-control" id="asn_email" placeholder="Email Pribadi"></div>
                <div class="col-md-6"><input class="form-control" id="asn_dom" placeholder="Alamat Domisili"></div>
                <div class="col-md-6"><input class="form-control" id="asn_ktp" placeholder="Alamat KTP"></div>

                <div class="col-md-6"><input class="form-control" id="asn_jabatan" placeholder="Jabatan"></div>
                <div class="col-md-6"><input class="form-control" id="asn_pendidikan" placeholder="Pendidikan"></div>

                <div class="col-md-6"><input class="form-control" id="asn_gol" placeholder="Gol/Pangkat"></div>
                <div class="col-md-6"><input class="form-control" id="asn_kelas" placeholder="Kelas Jabatan"></div>

                <div class="col-md-6"><input class="form-control" id="asn_tim" placeholder="Tim Regu"></div>
                <div class="col-md-6"><input class="form-control" id="asn_bidangSk" placeholder="Bidang SK/SPK"></div>
                <div class="col-md-6"><input class="form-control" id="asn_bidangPen" placeholder="Bidang Penempatan"></div>

                <div class="col-md-6"><input class="form-control" id="asn_pelanggaran" type="number" placeholder="Jumlah Pelanggaran" min="0" value="0"></div>

                <div class="col-md-6">
                  <label class="form-label">Upload SP (pdf/jpg/png)</label>
                  <input class="form-control" type="file" id="asn_sp" accept=".pdf,image/*">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Upload SK/SPK (pdf)</label>
                  <input class="form-control" type="file" id="asn_sk" accept=".pdf,image/*">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <select id="asn_status" class="form-select">
                    <option value="Aktif">Aktif</option>
                    <option value="Pindah Tugas">Pindah Tugas</option>
                    <option value="Mutasi">Mutasi</option>
                    <option value="Meninggal Dunia">Meninggal Dunia</option>
                    <option value="Diberhentikan">Diberhentikan</option>
                    <option value="Pensiun">Pensiun</option>
                  </select>
                </div>

              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="asn_save" type="submit">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- NON-ASN -->
<div id="nonasn" class="hidden">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>Database Non-ASN</h4>
    <div>
      <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalNONASN">
        <i class="fas fa-plus me-1"></i> Tambah Non-ASN
      </button>

      <button class="btn btn-sm btn-success me-2" onclick="document.getElementById('importNONASN').click()">
        <i class="fas fa-file-excel me-1"></i> Import Excel
      </button>
      <input type="file" id="importNONASN" accept=".xlsx,.xls" class="d-none">

      <button class="btn btn-sm btn-warning" onclick="exportNONASN()">
        <i class="fas fa-file-export me-1"></i> Export Excel
      </button>
    </div>
  </div>

  <div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Foto</th><th>Nama</th><th>NIK</th><th>TTL</th><th>Jenis Kelamin</th><th>No. Telepon</th><th>Email Pribadi</th>
        <th>Alamat Domisili</th><th>Alamat KTP</th><th>Jabatan</th><th>Pendidikan</th><th>Gol/Pangkat</th><th>Kelas Jabatan</th>
        <th>Tim Regu</th><th>Bidang SK/SPK</th><th>Bidang Penempatan</th><th>Jumlah Pelanggaran</th><th>Surat Peringatan</th>
        <th>SK/Spk</th><th>Status</th><th>Aksi</th>
      </tr>
    </thead>

    <tbody id="bodyNONASN"></tbody>
  </table>
  </div>
</div>

<!-- MODAL NON-ASN -->
<div class="modal fade" id="modalNONASN" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formNONASN">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNONASNTitle">Tambah NON ASN</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="nonasn_index" value="-1">

          <div class="row">
            <div class="col-md-3 text-center">
              <label class="form-label">Foto (jpg/png)</label>
              <img id="nonasn_photo_preview" class="img-fluid mb-2" style="max-height:120px; display:none; border:1px solid #ddd; padding:4px;">
              <input class="form-control" type="file" id="nonasn_photo" accept="image/*">
            </div>

            <div class="col-md-9">
              <div class="row g-2">

                <div class="col-md-6"><input class="form-control" id="nonasn_nama" placeholder="Nama" required></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_nik" placeholder="NIK" required></div>

                <div class="col-md-6"><input class="form-control" id="nonasn_ttl" placeholder="TTL" required></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_telp" placeholder="No. Telepon"></div>

                <div class="col-md-6">
                  <select id="nonasn_jk" class="form-select">
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                  </select>
                </div>

                <div class="col-md-6"><input class="form-control" id="nonasn_email" placeholder="Email Pribadi"></div>

                <div class="col-md-6"><input class="form-control" id="nonasn_dom" placeholder="Alamat Domisili"></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_ktp" placeholder="Alamat KTP"></div>

                <div class="col-md-6"><input class="form-control" id="nonasn_jabatan" placeholder="Jabatan"></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_pendidikan" placeholder="Pendidikan"></div>

               
                <div class="col-md-6"><input class="form-control" id="nonasn_kelas" placeholder="Kelas Jabatan"></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_tim" placeholder="Tim Regu"></div>

                <div class="col-md-6"><input class="form-control" id="nonasn_bidangSk" placeholder="Bidang SK/SKP"></div>
                <div class="col-md-6"><input class="form-control" id="nonasn_bidangPen" placeholder="Bidang Penempatan"></div>

                <div class="col-md-6"><input class="form-control" id="nonasn_pelanggaran" type="number" placeholder="Jumlah Pelanggaran" min="0" value="0"></div>

                <div class="col-md-6">
                  <label class="form-label">Upload SP (pdf/jpg/png)</label>
                  <input class="form-control" type="file" id="nonasn_sp" accept=".pdf,image/*">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Upload SK/SPK (pdf)</label>
                  <input class="form-control" type="file" id="nonasn_spk" accept=".pdf,image/*">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <select id="nonasn_status" class="form-select">
                    <option value="Aktif">Aktif</option>
                    <option value="Pindah Tugas">Pindah Tugas</option>
                    <option value="Mutasi">Mutasi</option>
                    <option value="Meninggal Dunia">Meninggal Dunia</option>
                    <option value="Diberhentikan">Diberhentikan</option>
                    <option value="Pensiun">Pensiun</option>
                  </select>
                </div>

              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="nonasn_save" type="submit">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- SETTING -->
<div id="settingPage" class="hidden">
    <h4><i class="fas fa-gear me-2"></i>Pengaturan Akun</h4>
    <hr>

    <form id="settingForm" style="max-width:400px;">
        <div class="mb-3">
            <label class="form-label">Username Baru</label>
            <input type="text" id="newUsername" class="form-control" placeholder="Masukkan username baru">
        </div>

        <div class="mb-3">
            <label class="form-label">Password Baru</label>
            <input type="password" id="newPassword" class="form-control" placeholder="Masukkan password baru">
        </div>

        <button type="submit" class="btn btn-success w-100">
            <i class="fas fa-save me-2"></i>Simpan Perubahan
        </button>
    </form>

    <div id="notifUpdate" class="alert alert-success mt-3 d-none">
        Data login berhasil diperbarui!
    </div>
</div>

<!-- HISTORY -->
<div id="historyPegawai" class="hidden">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="fas fa-clock-rotate-left me-2"></i>History Pegawai</h4>
    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalHistory">Tambah History</button>
  </div>

  <button class="btn btn-success mb-3" onclick="document.getElementById('importExcel').click()">
    <i class="fas fa-file-excel me-2"></i>Import Excel
  </button>
  <input type="file" id="importExcel" class="d-none" accept=".xlsx,.xls">

  <button class="btn btn-warning mb-3" onclick="exportExcelHistory()">
    <i class="fas fa-file-export me-2"></i>Export Excel
  </button>

  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Nama</th>
        <th>NIK/NIP</th>
        <th>Tim Regu</th>
        <th>Bidang Penempatan</th>
        <th>Keterangan</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="bodyHistory"></tbody>
  </table>
</div>

<!-- MODAL HISTORY -->
<div class="modal fade" id="modalHistory">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Tambah History Pegawai</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formHistory">
          <input class="form-control mb-2" id="hNama" placeholder="Nama" required>
          <input class="form-control mb-2" id="hNik" placeholder="Nik/Nip" required>
          <input class="form-control mb-2" id="hTim" placeholder="Tim Regu" required>
          <input class="form-control mb-2" id="hBidang" placeholder="Bidang Penempatan" required>
          <input class="form-control mb-2" id="hKeterangan" placeholder="Keterangan" required>

          <select id="hStatus" class="form-select mb-2">
            <option value="Pindah Tugas">Pindah Tugas</option>
            <option value="Mutasi Masuk">Mutasi Masuk</option>
            <option value="Mutasi Keluar">Mutasi Keluar</option>
            <option value="Diberhentikan">Diberhentikan</option>
            <option value="Mengundurkan Diri">Mengundurkan Diri</option>
            <option value="Meninggal Dunia">Meninggal Dunia</option>
            <option value="Pensiun">Pensiun</option>
            <option value="Tugas Belajar">Tugas Belajar</option>
            <option value="Bko/Diperbantukan">Bko/Diperbantukan</option>
            <option value="Cuti Panjang/CTLN">Cuti Panjang/CTLN</option>
            <option value="Non Aktif Sementara">Non Aktif Sementara</option>
          </select>

          <button class="btn btn-primary w-100 mt-2" type="submit">Simpan</button>
        </form>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -----------------------
   Inisialisasi DOM refs
   ----------------------- */
const bodyASN = document.getElementById('bodyASN');
const bodyNONASN = document.getElementById('bodyNONASN');
const bodyHistory = document.getElementById('bodyHistory');

const jumlahASN = document.getElementById('jumlahASN');
const jumlahNonASN = document.getElementById('jumlahNonASN');
const totalPelanggaran = document.getElementById('totalPelanggaran');

/* -----------------------
   Navigation
   ----------------------- */
function showPage(id, el){
  document.querySelectorAll('.main > div').forEach(div => div.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  if(el) el.classList.add('active');
}

/* ============================
   PENCARIAN
   ============================ */
function searchData() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const searchTable = document.getElementById("searchTable");
  const tbody = document.getElementById("searchResult");
  tbody.innerHTML = "";

  let dataASN = JSON.parse(localStorage.getItem("dataASN")) || [];
  let dataNON = JSON.parse(localStorage.getItem("dataNONASN")) || [];

  let combinedData = [...dataASN, ...dataNON];

  if(!keyword) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Masukkan kata kunci pencarian.</td></tr>';
    searchTable.style.display = "table";
    return;
  }

  let filtered = combinedData.filter(item => {
    const nama = (item.nama || item.nama_lengkap || '').toString().toLowerCase();
    const nip = (item.nip || item.nik || '').toString().toLowerCase();
    return nama.includes(keyword) || nip.includes(keyword);
  });

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">âš  Data tidak ditemukan</td></tr>';
    searchTable.style.display = "table";
    return;
  }

  filtered.forEach((row, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${row.nama || row.nama_lengkap || '-'}</td>
        <td>${row.nip || row.nik || '-'}</td>
        <td>${row.jabatan || '-'}</td>
        <td><span class="badge ${row.status === 'Aktif' ? 'bg-success' : 'bg-secondary'}">${row.status || '-'}</span></td>
      </tr>
    `;
  });

  searchTable.style.display = "table";
}

/* ============================
   PENYIMPANAN / RENDER TABLE
   ============================ */
function saveLocalHTML(){
  localStorage.setItem('asnHTML', bodyASN.innerHTML);
  localStorage.setItem('nonasnHTML', bodyNONASN.innerHTML);
  localStorage.setItem('historyHTML', bodyHistory.innerHTML);
}

function loadLocalHTML(){
  bodyASN.innerHTML = localStorage.getItem('asnHTML') || '';
  bodyNONASN.innerHTML = localStorage.getItem('nonasnHTML') || '';
  bodyHistory.innerHTML = localStorage.getItem('historyHTML') || '';
  updateStats();
}

/* ============================
   UPDATE STATS
   ============================ */
function updateStats(){
  jumlahASN.textContent = bodyASN.rows ? bodyASN.rows.length : bodyASN.getElementsByTagName('tr').length;
  jumlahNonASN.textContent = bodyNONASN.rows ? bodyNONASN.rows.length : bodyNONASN.getElementsByTagName('tr').length;
  let total = 0;
  document.querySelectorAll('#bodyASN tr,#bodyNONASN tr').forEach(r=>{
    let found = Array.from(r.cells).map(c=>c.textContent.trim()).find(t=>/^\d+$/.test(t));
    total += parseInt(found || 0);
  });
  totalPelanggaran.textContent = total;
}

/* ============================
   LOAD / RENDER NON-ASN dari localStorage dataNONASN (array)
   ============================ */
function loadNONASN() {
  let data = JSON.parse(localStorage.getItem("dataNONASN")) || [];
  let tbody = document.getElementById("bodyNONASN");
  tbody.innerHTML = "";

  data.forEach((row, i) => {
    tbody.innerHTML += `
      <tr>
        <td><img src="${row.foto || ''}" class="foto-pegawai" onerror="this.style.display='none'"></td>
        <td>${row.nama || "-"}</td>
        <td>${row.nip || "-"}</td>
        <td>${row.ttl || "-"}</td>
        <td>${row.jk || "-"}</td>
        <td>${row.telp || "-"}</td>
        <td>${row.email || "-"}</td>
        <td>${row.domisili || "-"}</td>
        <td>${row.ktp || "-"}</td>
        <td>${row.jabatan || "-"}</td>
        <td>${row.pendidikan || "-"}</td>
        <td>${row.gol || "-"}</td>
        <td>${row.kelas || "-"}</td>
        <td>${row.tim || "-"}</td>
        <td>${row.bidangSK || "-"}</td>
        <td>${row.penempatan || "-"}</td>
        <td>${row.pelanggaran || "0"}</td>
        <td>${row.sp || "-"}</td>
        <td>${row.sk || "-"}</td>
        <td>${row.status || "-"}</td>
        <td>
       <button class="btn btn-warning btn-sm" onclick="editNONASN(index)">
       <i class="fas fa-edit"></i>
       </button>
       <button class="btn btn-danger btn-sm" onclick="deleteNONASN(index)">
       <i class="fas fa-trash"></i>
       </button>
       </td>
      </tr>
    `;
  });

  document.getElementById("jumlahNonASN").innerText = data.length;
  saveLocalHTML();
  updateStats();
}

/* ============================
   Edit / Hapus NON-ASN
   ============================ */
// ======== DATA LOCAL STORAGE ========
let dataASN = JSON.parse(localStorage.getItem("dataASN")) || [];
let dataNONASN = JSON.parse(localStorage.getItem("dataNONASN")) || [];

// ======== SIMPAN KE STORAGE ========
function saveData() {
    localStorage.setItem("dataASN", JSON.stringify(dataASN));
    localStorage.setItem("dataNONASN", JSON.stringify(dataNONASN));
    renderTables();
    updateDashboard();
}

// RESET FORM
function resetForm() {
    document.getElementById("formPegawai").reset();
    document.getElementById("indexPegawai").value = "";
}

// TAMBAH ASN
function tambahASN() {
    resetForm();
    document.getElementById("jenisPegawai").value = "ASN";
    document.getElementById("modalTitle").innerText = "Tambah Pegawai ASN";
    $("#modalPegawai").modal("show");
}

// TAMBAH NON-ASN
function tambahNonASN() {
    resetForm();
    document.getElementById("jenisPegawai").value = "NONASN";
    document.getElementById("modalTitle").innerText = "Tambah Pegawai Non-ASN";
    $("#modalPegawai").modal("show");
}

// SIMPAN DATA (Tambah / Edit)
function simpanPegawai() {
    const jenis = document.getElementById("jenisPegawai").value;
    const index = document.getElementById("indexPegawai").value;

    const pegawai = {
        nip: document.getElementById("nip").value,
        nama: document.getElementById("nama").value,
        jk: document.getElementById("jk").value,
        pendidikan: document.getElementById("pendidikan").value,
        jabatan: document.getElementById("jabatan").value,
        alamat: document.getElementById("alamat").value
    };

    // EDIT
    if (index !== "") {
        if (jenis === "ASN") dataASN[index] = pegawai;
        else dataNONASN[index] = pegawai;

    // TAMBAH BARU
    } else {
        if (jenis === "ASN") dataASN.push(pegawai);
        else dataNONASN.push(pegawai);
    }

    saveData();
    $("#modalPegawai").modal("hide");
}

// EDIT ASN
function editASN(i) {
    const d = dataASN[i];

    document.getElementById("modalTitle").innerText = "Edit ASN";
    document.getElementById("jenisPegawai").value = "ASN";
    document.getElementById("indexPegawai").value = i;

    document.getElementById("nip").value = d.nip;
    document.getElementById("nama").value = d.nama;
    document.getElementById("jk").value = d.jk;
    document.getElementById("pendidikan").value = d.pendidikan;
    document.getElementById("jabatan").value = d.jabatan;
    document.getElementById("alamat").value = d.alamat;

    $("#modalPegawai").modal("show");
}

// EDIT NON-ASN
function editNonASN(i) {
    const d = dataNONASN[i];

    document.getElementById("modalTitle").innerText = "Edit Non-ASN";
    document.getElementById("jenisPegawai").value = "NONASN";
    document.getElementById("indexPegawai").value = i;

    document.getElementById("nip").value = d.nip;
    document.getElementById("nama").value = d.nama;
    document.getElementById("jk").value = d.jk;
    document.getElementById("pendidikan").value = d.pendidikan;
    document.getElementById("jabatan").value = d.jabatan;
    document.getElementById("alamat").value = d.alamat;

    $("#modalPegawai").modal("show");
}

// HAPUS ASN
function hapusASN(i) {
    if (confirm("Hapus ASN ini?")) {
        dataASN.splice(i, 1);
        saveData();
    }
}

// HAPUS NON-ASN
function hapusNonASN(i) {
    if (confirm("Hapus Non-ASN ini?")) {
        dataNONASN.splice(i, 1);
        saveData();
    }
}

// RENDER TABEL
function renderTables() {
    let asnHTML = "";
    dataASN.forEach((p, i) => {
        asnHTML += `
        <tr>
            <td>${i + 1}</td>
            <td>${p.nip}</td>
            <td>${p.nama}</td>
            <td>${p.jk}</td>
            <td>${p.pendidikan}</td>
            <td>${p.jabatan}</td>
            <td>${p.alamat}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editASN(${i})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="hapusASN(${i})">Delete</button>
            </td>
        </tr>`;
    });

    document.getElementById("tbodyASN").innerHTML = asnHTML;

    let nonHTML = "";
    dataNONASN.forEach((p, i) => {
        nonHTML += `
        <tr>
            <td>${i + 1}</td>
            <td>${p.nip}</td>
            <td>${p.nama}</td>
            <td>${p.jk}</td>
            <td>${p.pendidikan}</td>
            <td>${p.jabatan}</td>
            <td>${p.alamat}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editNonASN(${i})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="hapusNonASN(${i})">Delete</button>
            </td>
        </tr>`;
    });

    document.getElementById("tbodyNONASN").innerHTML = nonHTML;
}

// UPDATE DASHBOARD
function updateDashboard() {
    document.getElementById("jumlahASN").innerText = dataASN.length;
    document.getElementById("jumlahNONASN").innerText = dataNONASN.length;
}

/* ==========================================================
   IMPORT NON-ASN â€” FIX FORMAT EXCEL contoh.xlsx (FINAL)
   ========================================================== */
document.getElementById("importNONASN").addEventListener("change", function(e) {

    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.readAsArrayBuffer(file);

    reader.onload = function() {
        let workbook = XLSX.read(reader.result, { type: "array" });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let raw = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        let mapped = raw.map(row => ({
            foto: "",
            nama: row["NAMA"] || "",
            nip: row["NIK"] || "",
            ttl: row["TTL"] || "",
            jk: row["JENIS_KELAMIN"] || "",
            telp: row["NO_TELEPON"] || "",
            email: row["EMAIL_PRIBADI"] || "",
            domisili: row["ALAMAT_DOMISILI"] || "",
            ktp: row["ALAMAT_KTP"] || "",
            pendidikan: row["PENDIDIKAN"] || "",
            jabatan: row["JABATAN"] || "",
            gol: "-",
            kelas: row["KELAS_JABATAN"] || "",
            tim: row["TIM_REGU"] || "",
            bidangSK: row["BIDANG_BERDASARKAN_SK/SPK"] || "",
            penempatan: row["BIDANG_PENEMPATAN"] || "",
            pelanggaran: 0,
            sp: "",
            sk: "",
            status: "Aktif"
        }));

        localStorage.setItem("dataNONASN", JSON.stringify(mapped));
        alert("âœ” Import Excel Non-ASN Sukses & Data 100% Cocok dengan contoh.xlsx");
        loadNONASN();
    };
});

/* ============================
   Export NONASN (simple)
   ============================ */
function exportNONASN(){
  const table = document.querySelector('#bodyNONASN').parentElement.outerHTML;
  let file = new Blob(['\ufeff' + table], { type: 'application/vnd.ms-excel' });
  let url = URL.createObjectURL(file);
  let a = document.createElement("a");
  a.href = url;
  a.download = "NonASN.xls";
  a.click();
}

/* ============================
   Form NON-ASN submit
   ============================ */
document.getElementById("formNONASN").addEventListener("submit", function(e){
    e.preventDefault();
    saveNONASN();
});

  function saveNONASN(){
    let data = JSON.parse(localStorage.getItem("dataNONASN")) || [];

    let index = document.getElementById("nonasn_index").value;
    let nama = document.getElementById("nonasn_nama").value;

   let newData = {
    foto: fotoData,
    nama: document.getElementById("nonasn_nama").value,
    nik: document.getElementById("nonasn_nik").value,
    ttl: document.getElementById("nonasn_ttl").value,
    jk: document.getElementById("nonasn_jk").value,
    telp: document.getElementById("nonasn_telp").value,
    email: document.getElementById("nonasn_email").value,
    dom: document.getElementById("nonasn_dom").value,
    ktp: document.getElementById("nonasn_ktp").value,
    jabatan: document.getElementById("nonasn_jabatan").value,
    pendidikan: document.getElementById("nonasn_pendidikan").value,
    kelas: document.getElementById("nonasn_kelas").value,
    tim: document.getElementById("nonasn_tim")?.value || "",
    bidangSK: document.getElementById("nonasn_bidangSk")?.value || "",
    bidangPen: document.getElementById("nonasn_bidangPen")?.value || "",
    pelanggaran: document.getElementById("nonasn_pelanggaran").value,  // ðŸ‘ˆ WAJIB ADA INI
    suratPeringatan: fileSP,
    sk: fileSK,
    status: document.getElementById("nonasn_status").value
};

    // Edit
    if(index >= 0){
        data[index] = pegawai;
    }
    // Tambah baru
    else {
        data.push(pegawai);
    }

    localStorage.setItem("dataNONASN", JSON.stringify(data));

    // Reload tabel
    loadNONASN();

    // Tutup modal
    bootstrap.Modal.getInstance(document.getElementById("modalNONASN")).hide();

    // Reset form
    document.getElementById("formNONASN").reset();
}



/* ============================
   FORM HISTORY
   ============================ */
document.getElementById('formHistory').addEventListener('submit', e=>{
  e.preventDefault();
  const nama = document.getElementById('hNama').value.trim();
  const nik = document.getElementById('hNik').value.trim();
  const tim = document.getElementById('hTim').value.trim();
  const bidang = document.getElementById('hBidang').value.trim();
  const keterangan = document.getElementById('hKeterangan').value.trim();
  const status = document.getElementById('hStatus').value;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${nama}</td>
    <td>${nik}</td>
    <td>${tim}</td>
    <td>${bidang}</td>
    <td>${keterangan}</td>
    <td>${status}</td>
  `;
  bodyHistory.appendChild(row);
  saveLocalHTML();
  e.target.reset();
  bootstrap.Modal.getInstance(document.getElementById('modalHistory')).hide();
});

function updateStats() {
    jumlahASN.textContent = bodyASN.rows.length;
    jumlahNonASN.textContent = bodyNONASN.rows.length;

    let total = 0;
    
    // ASN: kolom pelanggaran index ke-16
    bodyASN.querySelectorAll("tr").forEach(r => {
        let pel = parseInt(r.cells[16]?.textContent || "0");
        total += isNaN(pel) ? 0 : pel;
    });

    // NON-ASN: kolom pelanggaran juga index ke-16
    bodyNONASN.querySelectorAll("tr").forEach(r => {
        let pel = parseInt(r.cells[16]?.textContent || "0");
        total += isNaN(pel) ? 0 : pel;
    });

    totalPelanggaran.textContent = total;
}

/* ============================
   Import Excel History
   ============================ */
document.getElementById("importExcel").addEventListener("change", function(e){
  alert("Import Excel history siap â€” file akan diolah jika Anda mau.");
});

/* ============================
   Export Excel History
   ============================ */
function exportExcelHistory() {
  let table = document.getElementById("bodyHistory").parentElement.outerHTML;
  let file = new Blob(['\ufeff' + table], { type: 'application/vnd.ms-excel' });
  let url = URL.createObjectURL(file);
  let a = document.createElement("a");
  a.href = url;
  a.download = "History_Pegawai.xls";
  a.click();
}

/* ============================
   Setting form
   ============================ */
const settingForm = document.getElementById("settingForm");
const notifUpdate = document.getElementById("notifUpdate");

settingForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const newUsername = document.getElementById("newUsername").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();

    if (newUsername && newPassword) {
        localStorage.setItem("username", newUsername);
        localStorage.setItem("password", newPassword);

        notifUpdate.classList.remove("d-none");
        setTimeout(() => { notifUpdate.classList.add("d-none"); }, 3000);
    } else {
        alert("Username dan Password tidak boleh kosong!");
    }
});

/* ============================
   Inisialisasi load
   ============================ */
loadLocalHTML();
loadNONASN();
updateStats();
</script>

</body>
</html>








